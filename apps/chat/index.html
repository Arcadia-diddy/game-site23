<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Study Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial,sans-serif;
      background:#000;
      color:#eee;
      padding:1rem;
      min-height:100vh;
      display:flex;
      justify-content:center;
    }
    .container{max-width:800px;width:100%;margin:0 auto}
    h1{font-size:2rem;text-align:center;margin:1rem 0;color:#0f0}
    .status{text-align:center;margin:1rem 0;font-size:0.9rem;color:#aaa}
    #roomCode{
      text-align:center;margin:1rem 0;padding:1rem;
      background:#111;border-radius:12px;
      font-family:monospace;font-size:1.8rem;letter-spacing:0.4ch;
      color:#0f0;
    }
    #messages{
      list-style:none;padding:1rem;background:#111;
      border-radius:12px;height:60vh;overflow-y:auto;margin-bottom:1rem;
      display:flex;flex-direction:column;
    }
    .msg{
      padding:0.8rem 1rem;border-radius:12px;margin:0.5rem 0;
      max-width:80%;word-wrap:break-word;position:relative;
    }
    .msg.me{background:#0f0;color:#000;align-self:flex-end}
    .msg.them{background:#222;color:#eee;align-self:flex-start}
    .msg.me::after{content:'';position:absolute;right:-8px;top:50%;transform:translateY(-50%);border:8px solid transparent;border-left-color:#0f0}
    .msg.them::after{content:'';position:absolute;left:-8px;top:50%;transform:translateY(-50%);border:8px solid transparent;border-right-color:#222}
    .msg span{display:block;font-size:0.75rem;margin-top:0.3rem;opacity:0.7}
    #inputArea{display:flex;gap:0.5rem}
    #messageInput{
      flex:1;padding:0.9rem;border-radius:12px;
      border:1px solid #333;background:#111;color:#fff;
      font-size:1rem;outline:none
    }
    #messageInput:focus{border-color:#0f0}
    #sendBtn{
      background:#0f0;color:#000;padding:0.9rem 1.5rem;
      border:none;border-radius:12px;font-weight:800;
      cursor:pointer;transition:.3s
    }
    #sendBtn:hover{transform:scale(1.05)}
    .flex{display:flex;flex-direction:column}
    .flex-center{align-items:center;justify-content:center;height:80vh}
    #nameScreen, #roomScreen, #chatScreen{display:none}
    input[type="text"]{
      width:100%;max-width:300px;padding:0.9rem;
      border-radius:12px;border:1px solid #333;
      background:#111;color:#fff;font-size:1rem;
      outline:none;text-align:center;margin:1rem 0
    }
    input[type="text"]:focus{border-color:#0f0}
    .copy-btn{
      background:#333;color:#eee;padding:0.5rem 1rem;
      border:none;border-radius:8px;font-size:0.8rem;
      cursor:pointer;margin-top:0.5rem
    }
    .copy-btn:hover{background:#0f0;color:#000}
    .error{color:#f66;text-align:center;margin:1rem}
  </style>
</head>
<body>
  <div class="container">

    <!-- NAME SCREEN -->
    <div id="nameScreen" class="flex-center">
      <div style="text-align:center">
        <h1>Study Chat</h1>
        <p style="color:#aaa">Choose your name:</p>
        <input type="text" id="nameInput" placeholder="e.g. Alex" maxlength="20">
        <button id="setNameBtn" style="margin-top:1rem;background:#0f0;color:#000;padding:0.8rem 1.5rem;border:none;border-radius:12px;font-weight:800;cursor:pointer">Continue</button>
      </div>
    </div>

    <!-- ROOM SCREEN -->
    <div id="roomScreen" class="flex-center">
      <p class="status">Share this room code:</p>
      <div id="roomCode">------</div>
      <button class="copy-btn" id="copyBtn">Copy Code</button>
      <p style="margin-top:1rem;color:#aaa">Or enter a code to join:</p>
      <input type="text" id="joinInput" placeholder="Enter code" maxlength="6">
      <button id="joinBtn" style="margin-top:0.5rem;background:#0066ff;color:#fff;padding:0.8rem 1.5rem;border:none;border-radius:12px;font-weight:600;cursor:pointer">Join</button>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chatScreen">
      <ul id="messages" class="flex"></ul>
      <div id="inputArea">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script>
    // === LOCAL CHAT USING localStorage + POLLING ===
    let myName = '';
    let roomCode = '';
    let lastMsgId = 0;

    const nameScreen = document.getElementById('nameScreen');
    const roomScreen = document.getElementById('roomScreen');
    const chatScreen = document.getElementById('chatScreen');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const roomCodeEl = document.getElementById('roomCode');
    const copyBtn = document.getElementById('copyBtn');
    const nameInput = document.getElementById('nameInput');
    const setNameBtn = document.getElementById('setNameBtn');
    const joinInput = document.getElementById('joinInput');
    const joinBtn = document.getElementById('joinBtn');

    // === GENERATE 6-DIGIT CODE ===
    function generateCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // === SAVE MESSAGE ===
    function saveMessage(text, sender) {
      const chat = JSON.parse(localStorage.getItem(`chat_${roomCode}`) || '[]');
      chat.push({
        id: Date.now(),
        text,
        sender,
        time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
      });
      localStorage.setItem(`chat_${roomCode}`, JSON.stringify(chat));
    }

    // === LOAD MESSAGES ===
    function loadMessages() {
      const chat = JSON.parse(localStorage.getItem(`chat_${roomCode}`) || '[]');
      const newMsgs = chat.filter(m => m.id > lastMsgId);
      newMsgs.forEach(msg => {
        const type = msg.sender === myName ? 'me' : 'them';
        addMessage(`${msg.text} <span>${msg.sender} â€¢ ${msg.time}</span>`, type);
        lastMsgId = msg.id;
      });
      if (newMsgs.length > 0) playSound();
    }

    // === ADD MESSAGE TO SCREEN ===
    function addMessage(html, type) {
      const li = document.createElement('li');
      li.className = `msg ${type}`;
      li.innerHTML = html;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    // === SEND MESSAGE ===
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      saveMessage(text, myName);
      messageInput.value = '';
      loadMessages(); // instant show
    }

    // === POLL FOR NEW MESSAGES ===
    function startPolling() {
      setInterval(loadMessages, 1000);
    }

    // === SET NAME ===
    setNameBtn.onclick = () => {
      myName = nameInput.value.trim() || 'User';
      if (myName.length > 20) myName = myName.slice(0, 20);
      nameScreen.style.display = 'none';
      roomScreen.style.display = 'block';

      // Try to load existing room from URL
      const urlParams = new URLSearchParams(location.search);
      roomCode = urlParams.get('room');
      if (roomCode && roomCode.length === 6) {
        roomCodeEl.textContent = roomCode;
        joinRoom();
        return;
      }

      // Generate new room
      roomCode = generateCode();
      roomCodeEl.textContent = roomCode;
      updateURL();
    };

    // === COPY CODE ===
    copyBtn.onclick = () => {
      const url = `${location.origin}${location.pathname}?room=${roomCode}`;
      navigator.clipboard.writeText(url).then(() => {
        copyBtn.textContent = 'Copied Link!';
        setTimeout(() => copyBtn.textContent = 'Copy Link', 2000);
      });
    };

    // === JOIN ROOM ===
    joinBtn.onclick = () => {
      const code = joinInput.value.trim();
      if (code.length !== 6) {
        alert('Code must be 6 digits');
        return;
      }
      roomCode = code;
      roomCodeEl.textContent = roomCode;
      updateURL();
      joinRoom();
    };

    function updateURL() {
      history.replaceState(null, '', `?room=${roomCode}`);
    }

    function joinRoom() {
      roomScreen.style.display = 'none';
      chatScreen.style.display = 'block';
      loadMessages();
      startPolling();
    }

    // === BUTTONS ===
    sendBtn.onclick = sendMessage;
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    // === SOUND ===
    function playSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      audio.play().catch(() => {});
    }

    // === AUTO-JOIN FROM URL ===
    window.addEventListener('load', () => {
      const urlParams = new URLSearchParams(location.search);
      if (urlParams.get('room')) {
        nameScreen.style.display = 'flex';
      } else {
        nameScreen.style.display = 'flex';
      }
    });

    // === SHOW NAME SCREEN ===
    nameScreen.style.display = 'flex';
  </script>
</body>
</html>