<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:Arial,sans-serif;
      background:#000;
      color:#eee;
      padding:1rem;
      min-height:100vh;
      display:flex;
      justify-content:center;
    }
    .container{max-width:800px;width:100%;margin:0 auto}
    h1{font-size:2rem;text-align:center;margin:1rem 0;color:#0f0}
    .status{text-align:center;margin:1rem 0;font-size:0.9rem;color:#aaa}
    #connectCode{
      text-align:center;margin:1rem 0;padding:1rem;
      background:#111;border-radius:12px;
      font-family:monospace;font-size:1.8rem;letter-spacing:0.4ch;
      color:#0f0;
    }
    #messages{
      list-style:none;padding:1rem;background:#111;
      border-radius:12px;height:60vh;overflow-y:auto;margin-bottom:1rem;
      display:flex;flex-direction:column;
    }
    .msg{
      padding:0.8rem 1rem;border-radius:12px;margin:0.5rem 0;
      max-width:80%;word-wrap:break-word;position:relative;
    }
    .msg.me{background:#0f0;color:#000;align-self:flex-end}
    .msg.them{background:#222;color:#eee;align-self:flex-start}
    .msg.me::after{content:'';position:absolute;right:-8px;top:50%;transform:translateY(-50%);border:8px solid transparent;border-left-color:#0f0}
    .msg.them::after{content:'';position:absolute;left:-8px;top:50%;transform:translateY(-50%);border:8px solid transparent;border-right-color:#222}
    .msg span{display:block;font-size:0.75rem;margin-top:0.3rem;opacity:0.7}
    #inputArea{display:flex;gap:0.5rem}
    #messageInput{
      flex:1;padding:0.9rem;border-radius:12px;
      border:1px solid #333;background:#111;color:#fff;
      font-size:1rem;outline:none
    }
    #messageInput:focus{border-color:#0f0}
    #sendBtn{
      background:#0f0;color:#000;padding:0.9rem 1.5rem;
      border:none;border-radius:12px;font-weight:800;
      cursor:pointer;transition:.3s
    }
    #sendBtn:hover{transform:scale(1.05)}
    #connectBtn{
      background:#0066ff;color:#fff;padding:0.8rem 1.5rem;
      border:none;border-radius:12px;font-weight:600;
      cursor:pointer;margin:1rem auto;display:block
    }
    .flex{display:flex;flex-direction:column}
    .flex-center{align-items:center;justify-content:center;height:80vh}
    #nameScreen, #connectScreen, #chatScreen{display:none}
    input[type="text"]{
      width:100%;max-width:300px;padding:0.9rem;
      border-radius:12px;border:1px solid #333;
      background:#111;color:#fff;font-size:1rem;
      outline:none;text-align:center;margin:1rem 0
    }
    input[type="text"]:focus{border-color:#0f0}
    .copy-btn{
      background:#333;color:#eee;padding:0.5rem 1rem;
      border:none;border-radius:8px;font-size:0.8rem;
      cursor:pointer;margin-top:0.5rem
    }
    .copy-btn:hover{background:#0f0;color:#000}
    .error{color:#f66;text-align:center;margin:1rem}
    .retry-btn{background:#f66;color:#000;padding:0.8rem;border-radius:12px;border:none;cursor:pointer;margin:1rem auto;display:block}
  </style>
</head>
<body>
  <div class="container">

    <!-- NAME SCREEN -->
    <div id="nameScreen" class="flex-center">
      <div style="text-align:center">
        <h1>Chat</h1>
        <p style="color:#aaa">Choose your name:</p>
        <input type="text" id="nameInput" placeholder="e.g. Alex" maxlength="20">
        <button id="setNameBtn" style="margin-top:1rem;background:#0f0;color:#000;padding:0.8rem 1.5rem;border:none;border-radius:12px;font-weight:800;cursor:pointer">Continue</button>
        <p class="error" id="errorMsg"></p>
      </div>
    </div>

    <!-- CONNECT SCREEN -->
    <div id="connectScreen" class="flex-center">
      <p class="status">Give this code to your friend:</p>
      <div id="connectCode">------</div>
      <button class="copy-btn" id="copyBtn">Copy Code</button>
      <p style="margin-top:1rem;color:#aaa">Or enter your friend's code:</p>
      <button id="connectBtn">Connect</button>
      <button class="retry-btn" id="retryBtn" style="display:none">Retry Connection</button>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chatScreen">
      <ul id="messages" class="flex"></ul>
      <div id="inputArea">
        <input type="text" id="messageInput" placeholder="Type a message..." autocomplete="off">
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    let peer = null;
    let conn = null;
    let myName = '';
    let theirName = 'Friend';
    let myId = '';

    const nameScreen = document.getElementById('nameScreen');
    const connectScreen = document.getElementById('connectScreen');
    const chatScreen = document.getElementById('chatScreen');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const connectBtn = document.getElementById('connectBtn');
    const connectCode = document.getElementById('connectCode');
    const copyBtn = document.getElementById('copyBtn');
    const nameInput = document.getElementById('nameInput');
    const setNameBtn = document.getElementById('setNameBtn');
    const errorMsg = document.getElementById('errorMsg');
    const retryBtn = document.getElementById('retryBtn');

    // === GENERATE RANDOM ID (NO CONFLICTS) ===
    function generateId() {
      return Math.random().toString(36).substring(2, 10); // Longer for uniqueness
    }

    // === SET NAME AND CREATE PEER ===
    setNameBtn.onclick = () => {
      myName = nameInput.value.trim() || 'User';
      if (myName.length > 20) myName = myName.slice(0, 20);

      errorMsg.textContent = '';
      retryBtn.style.display = 'none';

      // Generate random ID (no custom short codes to avoid conflicts)
      myId = generateId();
      connectCode.textContent = myId;

      // Use reliable free signaling server
      peer = new Peer(myId, {
        host: 'peerjs-0.herokuapp.com',  // Alternative reliable server
        port: 443,
        path: '/peerjs',
        secure: true,
        config: {
          iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },  // Google STUN for NAT
            { urls: 'stun:stun1.l.google.com:19302' }
          ]
        }
      });

      peer.on('open', (id) => {
        console.log('Connected with ID:', id);
        nameScreen.style.display = 'none';
        connectScreen.style.display = 'block';
      });

      peer.on('error', (err) => {
        console.error('Peer error:', err);
        if (err.type === 'unavailable-id' || err.type === 'network') {
          errorMsg.textContent = 'Server busy. Retrying...';
          retryBtn.style.display = 'block';
          retryBtn.onclick = () => location.reload();
        } else {
          errorMsg.textContent = 'Connection failed. Check Wi-Fi or try later.';
        }
      });

      // Incoming connection
      peer.on('connection', (incoming) => {
        conn = incoming;
        setupConnection(conn);
        connectScreen.style.display = 'none';
        chatScreen.style.display = 'block';
      });
    };

    nameInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') setNameBtn.click();
    });

    // === COPY BUTTON ===
    copyBtn.onclick = () => {
      navigator.clipboard.writeText(myId).then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy Code', 2000);
      }).catch(() => {
        prompt('Copy this code:', myId);
      });
    };

    // === CONNECT BUTTON ===
    connectBtn.onclick = () => {
      const id = prompt('Enter your friend\'s code:')?.trim();
      if (!id) return;
      if (id === myId) {
        alert("You can't chat with yourself!");
        return;
      }

      conn = peer.connect(id);
      setupConnection(conn);
      connectScreen.style.display = 'none';
      chatScreen.style.display = 'block';
    };

    // === SETUP CONNECTION ===
    function setupConnection(connection) {
      conn = connection;
      conn.on('open', () => {
        conn.send({ type: 'name', name: myName });
        addMessage('Connected!', 'system');
      });

      conn.on('data', (data) => {
        if (data.type === 'name') {
          theirName = data.name;
          addMessage(`${theirName} joined.`, 'system');
        } else {
          addMessage(data, 'them', theirName);
          playSound();
        }
      });

      conn.on('close', () => {
        addMessage(`${theirName} left.`, 'system');
      });

      conn.on('error', (err) => {
        addMessage('Connection lost: ' + err.message, 'system');
        // Auto-retry
        setTimeout(() => {
          conn = peer.connect(conn.peer);
          setupConnection(conn);
        }, 3000);
      });
    }

    // === SEND MESSAGE ===
    function sendMessage() {
      const msg = messageInput.value.trim();
      if (!msg || !conn) return;
      conn.send(msg);
      addMessage(msg, 'me', myName);
      messageInput.value = '';
      playSound();
    }

    sendBtn.onclick = sendMessage;
    messageInput.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    // === ADD MESSAGE ===
    function addMessage(text, type, sender = '') {
      const li = document.createElement('li');
      li.className = `msg ${type}`;
      li.innerHTML = `<div>${text}</div>${sender ? `<span>${sender}</span>` : ''}`;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }

    // === SOUND ===
    function playSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
      audio.play().catch(() => {});
    }

    // === SHOW NAME SCREEN ===
    nameScreen.style.display = 'flex';
  </script>
</body>
</html>